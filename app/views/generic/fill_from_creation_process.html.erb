<style>
    input[type="checkbox"], input[type="radio"]{
        opacity: 1;
    }
</style>

<%= javascript_include_tag "jquery.dataTables.min" %>
<%= javascript_include_tag "jquery.dataTables.bootstrap" %>

<!--ToDO: Making it more agile so that it can hanlde excel import and update form also.-->
<%= form_tag :review_form, :multipart => true do |f| %>
    <h1><%= @form_config[:name] %></h1>
    <div class="tabbable">
      <% if !params[:process_id].nil? %>
          <%= hidden_field_tag :process_id, params[:process_id] %>
          <%= hidden_field_tag :model_name, @model_name %>
          <%= hidden_field_tag :seq, params[:seq] %>
      <% end %>
      <ul class="nav nav-tabs" id="myTab">
        <% count = 0 %>
        <% @fields[:tabs].map { |i, v| v[:name] }.each_with_index do |tab, index| %>
            <li><a data-toggle="tab" href="#dropdown<%= index %>"><%= tab %></a></li>
            <% count =count+1 %>
        <% end %>
        <% if @approval %>
            <li><a data-toggle="tab" href="#dropdown<%= count %>">Approval</a></li>
            <% count = count +1 %>
        <% end %>
        <% if @notification %>
            <li><a data-toggle="tab" href="#dropdown<%= count %>">Notification</a></li>
            <% count = count +1 %>
        <% end %>
      </ul>
      <div class="tab-content">
        <% @fields_name = @fields[:tabs].map { |i, v| v } %>
        <% count1 = 0 %>
        <% @fields_name.each_with_index do |tab_val, index| %>
            <% count1 =count1+1 %>
            <% if tab_val[:type]!="sub-form" %>
                <div id="dropdown<%= index %>" class="tab-pane">
                  <div class="row-fluid">
                    <% @tab_val = tab_val[:cols].map { |i, v| v } %>
                    <% ti = 0 %>
                    <% @tab_val.each_with_index do |col_val, index| %>
                        <div class="span6">
                          <% @col_val = col_val.map { |i, v| v } %>
                          <% ti = index+1 %>
                          <% @col_val.each_with_index do |cv, indi| %>
                              <%# ti = ti + indi +index %>
                              <div class="control-group">
                                <label for="<%= cv[:label] %>" class="control-label"><%= cv[:label] %></label>

                                <div class="controls">
                                  <% case cv[:type] %>
                                  <% when "text_field_tag" %>
                                      <% if cv[:attribute].include?('code') %>
                                          <%= text_field_tag "#{params[:model_name]}[#{cv[:attribute]}]", @dynamic_code ,:readonly=>true, :tabindex => ti.to_s%>
                                      <% else %>
                                          <%= text_field_tag "#{params[:model_name]}[#{cv[:attribute]}]", "", :tabindex => ti.to_s %>
                                      <% end %>

                                  <% when "text_area_tag" %>
                                      <%= text_area_tag "#{params[:model_name]}[#{cv[:attribute]}]","", :tabindex => ti.to_s %>
                                  <% when "date_field_tag" %>
                                      <input type="text" size="30" name="<%= "#{params[:model_name]}[#{cv[:attribute]}]" %>" id="<%= "#{params[:model_name]}[#{cv[:attribute]}]" %>" data-date-format="dd-mm-yyyy" class="span6 date-picker" tabindex = <%=ti.to_s %> >
                                  <% when "check_box_tag" %>
                                      <%= check_box_tag "#{params[:model_name]}[#{cv[:attribute]}]",nil, :tabindex => ti.to_s %>
                                  <% when "file_field_tag" %>
                                      <%= file_field_tag "#{params[:model_name]}[#{cv[:attribute]}]",:tabindex => ti.to_s %>
                                  <% when "select_tag" %>
                                      <% if cv[:options] == 'model' %>
                                          <%= select_tag "#{params[:model_name]}[#{cv[:attribute]}]", options_from_collection_for_select(eval(cv[:class]).all, cv[:select], cv[:show]),{:tabindex => ti.to_s }%>
                                      <% else %>
                                          <%= select_tag "#{params[:model_name]}[#{cv[:attribute]}]", options_for_select([""]+ cv[:options]), { :tabindex => ti.to_s } %>
                                      <% end %>
                                  <% end %>
                                </div>
                              </div>
                              <% ti = ti +2 %>
                          <% end %>
                        </div>
                    <% end %>
                  </div>
                </div>
            <% else %>
                <% @tba = tab_val[:attribute] %>
                <div id="dropdown<%= index %>" class="tab-pane">
                  <div class="row-fluid">
                    <%= render :partial => 'generic/subform', :locals => {:fi => tab_val[:attribute], :form_index => 0, :main_form => params[:model_name]} %>
                  </div>
                  <input type="hidden" class="formIndex" value="0">
                  <input type="button" name="Add New SubForm" id="addNewSubform" value="Add New Subform" class="btn btn-info" onclick='add_new_subform(this,"<%= tab_val[:name] %>","<%= @tba %>","<%= params[:model_name] %>")'/>
                </div>

            <% end %>

        <% end %>
        <!--Approval tab html-->
        <% if @approval %>
            <div id="dropdown<%= count1 %>" class="tab-pane">
              <%= render :partial => 'generic/approval_form' %>
            </div>
            <% count1 = count1 +1 %>
        <% end %>
        <!--Notification Tab html-->
        <% if @notification %>
            <div id="dropdown<%= count1 %>" class="tab-pane">
              <div class="row-fluid">
                <div class="span6">
                  <div class="control-group">
                    <label for="Title" class="control-label">Title</label>

                    <div class="controls">
                      <%= text_field_tag "notification[title]" %>
                    </div>
                  </div>
                  <div class="span6">
                    <div class="control-group">
                      <label for="description" class="control-label">Description</label>

                      <div class="controls">
                        <%= text_area_tag "notification[description]" %>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="row-fluid">
                <div class="span6">
                  <div class="control-group">
                    <label for="Title" class="control-label">Select EmployeeMaster, GroupMaster, Role</label>

                    <div class="controls">
                      <%= select_tag "notification[oClass]", options_for_select([["Employee Master", "EmployeeMaster"], ["Group Master", "GroupMaster"], ["Role", "Role"], ["Vendor Master", "VendorMaster"]]), {:include_blank => true, class: 'auto_assign_tos', :onchange => 'display_objects($(this),"notification[action_arr][]");'} %>
                    </div>
                  </div>
                </div>
                <div class="span6">
                  <div class="users-list_header table-header">Listing Objects</div>
                  <h5 class="not-available-text">No objects available.</h5>
                  <table class="users-list indexing table table-striped table-bordered table-hover" style="display: none;">
                    <tr>
                      <th>Select Multiple</th>
                      <th>Select Single</th>
                      <th>Field 1</th>
                      <th>Field 2</th>
                    </tr>
                    <tr>
                    </tr>
                  </table>
                </div>
              </div>
            </div>
            <% count1 = count1 +1 %>
        <% end %>
      </div>
    </div>
    <div class="form-actions">
      <%#= f.submit :class => "btn btn-info" %>
      <%= submit_tag "Submit", :class => "btn btn-info" %>
    </div>
<% end %>

<script type="text/javascript" charset="utf-8">
    var ddchildlen;
    $(function () {
        ddchildlen = $('#myTab').children.length;
        $("#dropdown0").addClass("active");
    });
    //Function to add nested subform
    function add_new_subform(this_obj, title, tba, model_name) {
        var data = {fi: [], form_index: [], main_form: []};
        data["fi"].push(tba);
        data["form_index"].push(parseInt($(this_obj).prev().val()) + 1);
        data["main_form"].push(model_name);
        $.ajax({
            url: "<%= subform_path %>",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(data),
            success: function (data) {
                $(this_obj).prev().val(parseInt($(this_obj).prev().val()) + 1);
                var a = "dropdown" + ddchildlen
                $('#myTab').append('<li><a data-toggle="tab" href="#' + a + '">' + title + '</a></li>');
                var newDiv = $(this_obj).parent().append('<div id="' + a + '" class="tab-pane"></div>');
                $("#" + a).append(data);
                ddchildlen++;
            }
        });
    }

    //function add nested subform on subform
    function add_new_nested_fields(this_obj, nf, main_form, fi, form_index, this_sf) {
        var data = {new_fields: [], main_form: [], fi: [], form_index: [], this_sf: [], my_index: []};
        data["new_fields"].push(nf);
        data["main_form"].push(main_form.toString());
        data["fi"].push(fi.toString());
        data["form_index"].push(form_index);
        data["this_sf"].push(this_sf.toString());
        data["my_index"].push($(this_obj).parent().find('.my_index').val());
        $.ajax({
            url: "<%= nested_subform_path %>",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(data),
            success: function (data) {
                $(this_obj).parent().find('.my_index').val(parseInt($(this_obj).parent().find('.my_index').val()) + 1);
                console.log(data);
                $(this_obj).parent().find('.my_body').append(data);
            }
        });
    }

    //function to add new nested subform on tab
    function add_nestsed_approvers_tab(this_obj) {
        var data = {counter: []};
        data["counter"].push($(this_obj).prev().val());
        $.ajax({
            url: "<%= approver_form_path %>",
            type: "POST",
            contentType: "application/json",
            data: JSON.stringify(data),
            success: function (data) {
                $(this_obj).prev().val(parseInt($(this_obj).prev().val()) + 1);
                var a = "appdropdown" + $(this_obj).prev().val();
                $(this_obj).parent().before('<li><a data-toggle="tab" href="#' + a + '">' + $(this_obj).prev().val() + '</a></li>');
                var newDiv = $('#myAppTab').next().append('<div id="' + a + '" class="tab-pane"></div>');
                $("#" + a).append(data);
            }
        });
    }

    //Code to display all the record of a particular model......
    function display_objects(this_obj, oobj) {
        var count = 0;
        var parent_tab = $(this_obj).parents('.row-fluid')[0];
        $(parent_tab).find('.users-list').dataTable().fnDestroy();
        //console.log(parent_tab);
        var model_name = $(this_obj).val();
        var data = {model_name: []};
        data["model_name"].push(model_name);
        $.ajax({
            url: "/get_column_data",
            type: "post",
            async: false,
            data: JSON.stringify(data),
            contentType: "application/json",
            success: function (data) {
                $(parent_tab).find('.users-list').show();
                $(parent_tab).find('.not-available-text').hide();
                var $user_row;
                var second_row_tds_len = 0;
                $(parent_tab).find(".users-list").find("tr:first").find("th:gt(0)").empty().remove();
                $(parent_tab).find(".users-list").find('tbody').empty();

                if (model_name == "EmployeeMaster") {
                    for (var i = 0; i < data.length; i++) {
                        my_id = data[i]["_id"];
                        $user_row = '<tr>' +
                                '<td style="position: relative;"><input type="checkbox" name="' + oobj + '" value=' + my_id + ' class="user_select_checkbox" style="position: relative; top: 0;"></td>' +
                                '<td>' + data[i]["employee_name"] + '</td><td>' + data[i]["official_email"] + '</td></tr>';
                        $(parent_tab).find(".users-list").append($user_row);
                    }
                    //$(parent_tab).find(".users-list").find("tr:first").find("th:last").show();
                    second_row_tds_len = $(parent_tab).find(".users-list tr").eq(1).find("td").length;
                }
                else if (model_name == "GroupMaster") {
                    for (var i = 0; i < data.length; i++) {
                        my_id = data[i]["_id"];
                        $user_row = '<tr>' +
                                '<td style="position: relative;"><input type="checkbox" name="action_arr[' + count + '][]" value=' + my_id + ' class="user_select_checkbox" style="position: relative; top: 0;"></td>' +
                                '<td>' + data[i]["group_name"] + '</td></tr>';
                        $(parent_tab).find(".users-list").append($user_row);
                    }
                    //$(parent_tab).find(".users-list").find("tr:first").find("th:last").hide();
                    second_row_tds_len = $(parent_tab).find(".users-list tr").eq(1).find("td").length;
                }
                else if (model_name == "Role") {
                    for (var i = 0; i < data.length; i++) {
                        my_id = data[i]["_id"];
                        $user_row = '<tr>' +
                                '<td style="position: relative;"><input type="checkbox" name="action_arr[' + count + '][]" value=' + my_id + ' class="user_select_checkbox" style="position: relative; top: 0;"></td>' +
                                '<td>' + data[i]["name"] + '</td></tr>';
                        $(parent_tab).find(".users-list").append($user_row);
                    }
                    //$(parent_tab).find(".users-list").find("tr:first").find("th:last").hide();
                    second_row_tds_len = $(parent_tab).find(".users-list tr").eq(1).find("td").length;
                }
                else if (model_name == "VendorMaster") {
                    for (var i = 0; i < data.length; i++) {
                        my_id = data[i]["_id"];
                        $user_row = '<tr>' +
                                '<td style="position: relative;"><input type="checkbox" name="action_arr[' + count + '][]" value=' + my_id + ' class="user_select_checkbox" style="position: relative; top: 0;"></td>' +
                                '<td>' + data[i]["vendor_name"] + '</td><td>' + data[i]["vendor_type"] + '</td></tr>';
                        $(parent_tab).find(".users-list").append($user_row);
                    }
                    //$(parent_tab).find(".users-list").find("tr:first").find("th:last").show();
                    second_row_tds_len = $(parent_tab).find(".users-list tr").eq(1).find("td").length;
                }
                $(':checkbox, :radio').css('opacity', '1');

                var EmpMasterCols = ["Name", "Email"];
                var GrpMasterCols = ["Group Name"];
                var RoleMasterCols = ["Role Name"];
                var VendorMasterCols = ["Vendor Name"];

                for (var i = 0; i < (second_row_tds_len-1); i++) {
                    if (model_name == "EmployeeMaster") {
                        $(parent_tab).find(".users-list").find("tr:first").append('<th>'+EmpMasterCols[i]+'</th>');
                    }
                    else if (model_name == "GroupMaster") {
                        $(parent_tab).find(".users-list").find("tr:first").append('<th>'+GrpMasterCols[i]+'</th>');
                    }
                    else if (model_name == "Role") {
                        $(parent_tab).find(".users-list").find("tr:first").append('<th>'+RoleMasterCols[i]+'</th>');
                    }
                    else if (model_name == "VendorMaster") {
                        $(parent_tab).find(".users-list").find("tr:first").append('<th>'+VendorMasterCols[i]+'</th>');
                    }
                }

                initDataTables();
            }
        });
    }

    function initDataTables(){
        var oTable = $('.users-list').dataTable();
        //oTable.fnClearTable();
        oTable.fnDraw();
    }
</script>