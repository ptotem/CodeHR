<%= nested_form_for(@master_pro) do |f| %>
  <% if @master_pro.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(@master_pro.errors.count, "error") %> prohibited this master_pro from being saved:</h2>

      <ul>
      <% @master_pro.errors.full_messages.each do |msg| %>
        <li><%= msg %></li>
      <% end %>
      </ul>
    </div>
  <% end %>

  <div class="row-fluid">
    <div class="span6">
      <div class="control-group">
        <label class="control-label">Name</label>
        <div class="controls">
              <%= f.text_field :name %>
        </div>
      </div>
    </div>
  </div>

    <hr>
    <div class="page-header position-relative">
      <h3>Master Steps</h3>
    </div>
    <div class="row-fluid">
      <div class="span12">
        <%= f.fields_for :master_steps do |master_step| %>

            <div class="row-fluid">
              <div class="span6">
                <div class="control-group">
                  <label class="control-label">Step Name</label>
                  <div class="controls">
                    <%= master_step.text_field :step_name %>
                  </div>
                </div>
              </div>
            </div>

            <div class="row-fluid">
              <div class="span4">
                <div class="control-group">
                  <label class="control-label">Action</label>
                  <div class="controls">
                    <%= master_step.select :action, options_for_select(["Fill", "Update", "Approve", "Notify", "SpawnD", "SpawnI"], disabled: "", :selected => master_step.object.action), {:class=>"my_cls"}, :onchange=>"model_select_control($(this));" %>
                  </div>
                </div>
              </div>
              <div class="span4">
                <div class="control-group">
                  <label class="control-label">Action Class</label>
                  <div class="controls model-select-dropdown-container">
                    <% @models = Dir["#{Rails.root}/app/models/*.rb"].map{|i| i.sub('.rb','').sub("#{Rails.root}/app/models/","").underscore.camelize} %>
                    <%= master_step.select :action_class, options_for_select(["","System"]+@models.collect{ |u| [u] }, :include_blank => "Select", :selected => master_step.object.action_class), {:class => "models-select"}  %>
                  </div>
                  <div class="controls an-select-dropdown-container" style="display: none;">
                    <%= master_step.select :action_class, options_for_select(["True", "False"], disabled: "", :selected => master_step.object.action_class) %>
                  </div>
                </div>
              </div>
              <div class="span4">
                <div class="control-group">
                  <label class="control-label">Action Parameter</label>
                  <div class="controls">
                    <%= master_step.text_area :action_parameter, :rows=>"5", :cols=>"4" %>
                  </div>
                </div>
              </div>
            </div>

            <%= master_step.link_to_remove "Remove this task" %>
            <hr>
        <% end %>
        <p><%= f.link_to_add "Add a task", :master_steps %></p>
      </div>
    </div>


  <br>
  <div class="actions">
    <%= f.submit :class=>"btn btn-info" %>
  </div>
<% end %>

<script>
  $(function(){

  });

  function model_select_control(this_obj){
      var action_name = $(this_obj).val();
      var parent_field = $(this_obj).parent().parent().parent().parent().parent().parent();
      var models_dropdown = $(parent_field).find(".model-select-dropdown-container");
      var an_select_dropdown = $(parent_field).find(".an-select-dropdown-container");

      if ( (action_name == "Approve") || (action_name == "Notify") ) {
          $(models_dropdown).hide();
          $(an_select_dropdown).show();
      }
      else{
          $(models_dropdown).show();
          $(an_select_dropdown).hide();
      }
  }
</script>
