<div class="row-fluid">
  <div class="span4">
    <div class="table-header">Listing Objects</div>
    <table id="objects_table" class="table table-striped table-bordered table-hover">
      <thead>
          <tr>
            <th>Object Name</th>
          </tr>
      </thead>
      <tbody>
        <% @models.each do |model| %>
          <tr>
            <td>
                <!--<label class="custom-control-label" style="padding:0 0 0 4%;">-->
                  <%#= radio_button_tag 'action_option', model, false, :class => "action_input" %>
                    <!--<span class="lbl" style="padding-left: 5px;"><%#= model %></span>-->
                  <%= radio_button_tag 'action_option', model, false, :class => "action_input" , :onclick=>"get_my_data($(this));" %>
                    <span class="lbl" style="padding-left: 5px;"><%= model %></span>
                <!--</label>-->
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <div class="span4" id="mmod" style="display: none;">
    <div class="table-header">Listing Selected Object's Columns</div>
    <table id="object_fields_table" class="table table-striped table-bordered table-hover">
      <thead><tr><th>Object Name</th></tr></thead>
      <tbody>
      </tbody>
    </table>
  </div>

  <div class="span4" id="main-tab" style="display: none;">
    <!--<div class="table-header">Listing Selected Object's Field/Value</div>-->
    <!--<table id="report_table" class="table table-striped table-bordered table-hover">-->
      <!--<thead></thead>-->
      <!--<tbody id="dis_tab"></tbody>-->
    <!--</table>-->
  </div>
</div>

<script src="/assets/bootstrap-datepicker.min.js"></script>

<%= javascript_include_tag "jquery.dataTables.min" %>
<%= javascript_include_tag "jquery.dataTables.zbootstrap" %>
<%= javascript_include_tag "custom_dataTable" %>


<script type="text/javascript">

    $(function(){
        apply_dataTable('#objects_table', '#objects_table_wrapper','#objects_table_length', '#objects_table_filter');
    });

    var selected_field=[];
    var associated_field=[];
    var all_fields=[];
    var class_name='';
    var grp_name=''
    var my_fields;
    var my_count = 0;
    var result_div;

    function get_my_data(this_obj){

        class_name = $(this_obj).val();
        $('#mmod').show();
        var object_fields_table = $('#mmod').find('#object_fields_table').find('tbody');

        var tableHeader = "<thead><tr><th>Object Name</th></tr></thead>";

        $.get('/get_fields/'+$(this_obj).val(),function(data){
            $(object_fields_table).html('');
            $('#object_fields_table').append('<button onclick="select_field()">OK</button>');

            $.each(data.col_name,function(i,v){
                $(object_fields_table).append('<tr><td>' +
                        '<input class="children-steps-control" type="checkbox" value='+v+' name="cbl" style="opacity: 1;">'+
                        '<label style="margin-left:20px" control-label">'+v+'</label>'+
                        '</td></tr>');
            });

            apply_dataTable('#object_fields_table', '#object_fields_table_wrapper','#object_fields_table_length', '#object_fields_table_filter');

            var tableClass, tableID;

            $.each(data.association,function(i,v){
                $('#mmod').append('<div class="table-header">'+v.class_name+'</div>');
                tableClass = v.class_name;
                $('#mmod').append('<table class="dataTable table table-striped table-bordered table-hover table-'+ tableClass +' " id="object_associated_fields_table_'+i+'">' +
                        '<thead><tr><th>Object Name</th></tr></thead>'+
                        '<tbody></tbody>' +
                        '</table>');

                $.each(v.fields,function(i,vi){
                    $('.table-'+tableClass).find('tbody').append('<tr><td>'+
                            '<input type="hidden" value="'+ v.class_name+'">'+
                            '<input class="children-steps-control associated" type="checkbox" value='+vi+' name="cbl" style="opacity: 1;">'+
                            '<label style="margin-left:20px" control-label">'+vi+'</label>'+
                            '</td></tr>');
                });
                tableID = "object_associated_fields_table_"+i;
                apply_dataTable('#'+tableID, '#'+tableID+'_wrapper','#'+tableID+'_length', '#'+tableID+'_filter');
            });
        });

    }

    function select_field(){
        selected_field=[];
        associated_field=[];
        all_fields=[];
        $("input:checkbox[name=cbl]:checked").each(function(){
            all_fields.push(this.value)
            if($(this).hasClass("associated")){
                associated_field.push({classname: $(this).prev().val(), myfield: this.value})
            }else{
                selected_field.push(this.value);
            }
        });
        show_fields();
    }

    function show_fields(){
        a='';
        b='';
        all_fields.each(function(i,v){
            a=a+'<option value='+i+'>'+i+'</option>';
            b=b+'<th>'+i+'</th>';
        });
        result_div = class_name+"_result_"+my_count;
        $('#main-tab').append("<div id="+result_div+"></div>");
        $('#main-tab').find("#"+result_div).append('<lable>Group by: </lable><select id="'+class_name+'_grp_dec_'+my_count+'">'+a+'</select>');
        $('#main-tab').find("#"+result_div).append('<button onclick="load_fields($(this))">OK</button>');

        var table_html = "<div class=table-header>Listing Selected Objects Field/Value</div>" +
                 "<table class='table table-striped table-bordered table-hover' id=report_table_"+result_div+">" +
                    "<thead>" +
                        "<tr>"+b+"</tr>" +
                    "</thead>" +
                    "<tbody id=dis_tab_"+result_div+">" +
                    "</tbody>" +
                  "</table>";

        $('#main-tab').find("#"+result_div).append(table_html);
        $('#main-tab').show();

        my_count = my_count + 1;

    }

    function load_fields(this_obj){
        grp_name = $(this_obj).prev().val();
        var data = {field: [],association: [], classname: [], group_by: []}
        data["classname"].push(class_name);
        data["group_by"].push(grp_name);
        data["field"].push(selected_field);
        data["association"].push(associated_field);
        my_fields = data["association"];
        $.ajax({
            type: "POST",
            url: "/get_data",
            data: JSON.stringify(data),
            contentType: "application/json; charset=utf-8",
            //dataType: "json",
            success: function(result){
                //my_count = my_count + 1;
                current_row ="";
                var table_row = "";
                var object_field_val_table =  $("#main-tab").find("#"+result_div).find("#report_table_"+result_div);
                var dis_table_tab = "dis_tab_"+result_div;


                for(var i= 0 ;i< result.length;i++)
                {
                    //console.log(result[i][grp_name]);
                    //if($("#"+result[i][grp_name]).length === 0)
                    //{
                        $(object_field_val_table).find("#"+dis_table_tab).append("<tr id="+result[i][grp_name]+"></tr>");
                        for(var j=0;j<Object.keys(result[i]).length;j++)
                        {
                            //$("#"+result[i][grp_name]).append("<td>"+result[i][Object.keys(result[i])[j]]+"</td>");
                            $(object_field_val_table).find("#"+dis_table_tab).find('tr:eq('+i+')').append("<td>"+result[i][Object.keys(result[i])[j]]+"</td>");
                        }
                        table_row = "";
                    //}

                }

                $("#"+result_div).append('<div class=row-fluid>' +
                                            '<div class=span6>' +
                                                '<button class="btn btn-small btn-primary" onclick="add_to_report($(this), class_name)"> Add to Report </button>' +
                                            '</div>' +
                                            '<div class=span6>' +
                                                '<button class="btn btn-small btn-primary"> New Report </button>' +
                                            '</div>' +
                                          '</div>' +
                                          '<hr>');

                if ( my_count <= 1 ) {
                    var report_fields_html = '<div class="row-fluid report-fields">' +
                                                '<div class="span6">' +
                                                    '<input type="text" id="reviewed_by" style="width: 70%;" placeholder="Reviewed By">' +
                                                '</div>' +
                                             '</div>' +
                                             '<div class="row-fluid input-append date">' +
                                                '<input type="text" id="report_date" placeholder="Report Date" data-date-format="dd-mm-yyyy" class="span6 date-picker">' +
                                                '<span class="add-on"><i class="icon-calendar"></i></span>' +
                                             '</div>' +
                                             '<hr>'+'<div class="row-fluid input-append name">' +
                                                '<input type="text" id="report_name" placeholder="Report Name" class="span6">' +

                                             '</div>' +
                                             '<hr>';


                    $('#main-tab').prepend(report_fields_html);

                    $('.date-picker').datepicker();

                    $('body').on('click', function(){
                        $('.date-picker').show();
                    });

                }

                //console.log("report_table_"+result_div);
                setTimeout(function() {
                    var div_t = "report_table_"+result_div;
                    apply_dataTable("#"+div_t, '#'+div_t+'_wrapper','#'+div_t+'_length', '#'+div_t+'_filter');
                }, 800);



            }
        });
    }

    function add_to_report(this_obj, main_class){

        var this_table = $(this_obj).parent().parent().prev().attr('id');

        var tr = $("#"+this_table).find('tbody tr');
        var tr_len = $(tr).length;

        var reviewed_by = $('#main-tab').find("#reviewed_by").val();
        var report_date = $('#main-tab').find("#report_date").val();
        var report_name = $('#main-tab').find("#report_name").val();

        var newArray=[];

        $(tr).each(function(index,ele) {
            var subArray=[];

            $(ele).find('td').each(function(j, elem){
                subArray.push($(elem).text());
            });
            newArray.push(subArray);
        });
        //console.log(newArray);

        var data = {cl_name: [], cl_fields: [], newArray: [], reviewed_by: [], report_date: [],report_name:[]};
        data["cl_name"].push(class_name);
        data["cl_fields"].push(all_fields);
        data["newArray"].push(newArray);
        data["reviewed_by"].push(reviewed_by);
        data["report_date"].push(report_date);
        data["report_name"].push(report_name);

        $.ajax({
            type: "POST",
            url: "/my_report",
            data: JSON.stringify(data),
            contentType: "application/json; charset=utf-8",
            //dataType: "json",
            success: function(result){
                //console.log(result);
            }
        });

    }
</script>