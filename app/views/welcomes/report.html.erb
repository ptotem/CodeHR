<div class="row-fluid">
  <div class="span4">
    <div class="table-header">Listing Objects</div>
    <table id="objects_table" class="table table-striped table-bordered table-hover">
      <thead>
          <tr>
            <th>Object Name</th>
          </tr>
      </thead>
      <tbody>
        <% @models.each do |model| %>
          <tr>
            <td>
                <!--<label class="custom-control-label" style="padding:0 0 0 4%;">-->
                  <%= radio_button_tag 'action_option', model, false, :class => "action_input" %><span class="lbl" style="padding-left: 5px;"><%= model %></span>
                <!--</label>-->
            </td>
          </tr>
        <% end %>
      </tbody>
    </table>
  </div>

  <div class="span4" id="mmod">
    <div class="table-header">Listing Selected Object's Columns</div>
    <table id="object_fields_table" class="table table-striped table-bordered table-hover">
      <thead><tr><th>Object Name</th></tr></thead>
      <tbody>
      </tbody>
    </table>
  </div>

  <div class="span4" id="main-tab">
    <div class="table-header">Listing Selected Object's Field/Value</div>
    <table id="report_table" class="table table-striped table-bordered table-hover">
      <thead></thead>
      <tbody id="dis_tab"></tbody>
    </table>
  </div>
</div>


<%= javascript_include_tag "jquery.dataTables.min" %>
<%= javascript_include_tag "jquery.dataTables.bootstrap" %>
<%= javascript_include_tag "custom_dataTable" %>


<script type="text/javascript">

    //$(function(){
        apply_dataTable('#objects_table', '#objects_table_wrapper','#objects_table_length', '#objects_table_filter');
    //});

    var selected_field=[];
    var associated_field=[];
    var all_fields=[];
    var class_name='';
    var grp_name=''
    $('.action_input').on('click',function(){
        class_name=this.value;
        var object_fields_table = $('#mmod').find('#object_fields_table').find('tbody');

        var tableHeader = "<thead><tr><th>Object Name</th></tr></thead>";

        $.get('/get_fields/'+this.value,function(data){
            $(object_fields_table).html('');
            $('#object_fields_table').append('<button onclick="select_field()">OK</button>');

            $.each(data.col_name,function(i,v){
                $(object_fields_table).append('<tr><td>' +
                        '<input class="children-steps-control" type="checkbox" value='+v+' name="cbl" style="opacity: 1;">'+
                        '<label style="margin-left:20px" control-label">'+v+'</label>'+
                        '</td></tr>');
            });

            apply_dataTable('#object_fields_table', '#object_fields_table_wrapper','#object_fields_table_length', '#object_fields_table_filter');

            var tableClass, tableID;

            $.each(data.association,function(i,v){
                $('#mmod').append('<div class="table-header">'+v.class_name+'</div>');
                tableClass = v.class_name;
                $('#mmod').append('<table class="dataTable table table-striped table-bordered table-hover table-'+ tableClass +' " id="object_associated_fields_table_'+i+'">' +
                                    '<thead><tr><th>Object Name</th></tr></thead>'+
                                    '<tbody></tbody>' +
                        '</table>');

                $.each(v.fields,function(i,vi){
                    $('.table-'+tableClass).find('tbody').append('<tr><td>'+
                            '<input type="hidden" value="'+ v.class_name+'">'+
                            '<input class="children-steps-control associated" type="checkbox" value='+vi+' name="cbl" style="opacity: 1;">'+
                            '<label style="margin-left:20px" control-label">'+vi+'</label>'+
                            '</td></tr>');
                });
                tableID = "object_associated_fields_table_"+i;
                apply_dataTable('#'+tableID, '#'+tableID+'_wrapper','#'+tableID+'_length', '#'+tableID+'_filter');
            });
        });

    });


    function select_field(){
        selected_field=[];
        associated_field=[];
        all_fields=[];
        $("input:checkbox[name=cbl]:checked").each(function(){
            all_fields.push(this.value)
            if($(this).hasClass("associated")){
                associated_field.push({classname: $(this).prev().val(), myfield: this.value})
            }else{
                selected_field.push(this.value);
            }
        });
        show_fields();
    }

    function show_fields(){
        a='';
        b='';
        all_fields.each(function(i,v){
            a=a+'<option value='+i+'>'+i+'</option>';
            b=b+'<th>'+i+'</th>';
        });
        var object_field_val_table = $('#main-tab').find('#report_table');
        $('#main-tab').prepend('<lable>Group by: </lable><select id="grp_dec">'+a+'</select>');
        $('#main-tab').prepend('<button onclick="load_fields()">OK</button>')
        //$('#main-tab').append('<table id="report_table"><tbody id="dis_tab"><tr>'+b+'</tr></tbody></table>');
        //console.log(b);
        $(object_field_val_table).find('thead').append('<tr>'+b+'</td>');
    }

    function load_fields(){
        grp_name=$('#grp_dec').val();
        //alert(grp_name);
        var data = {field: [],association: [], classname: [], group_by: []}
        data["classname"].push(class_name);
        data["group_by"].push(grp_name);
        data["field"].push(selected_field);
        data["association"].push(associated_field);
        $.ajax({
            type: "POST",
            url: "/get_data",
            data: JSON.stringify(data),
            contentType: "application/json; charset=utf-8",
            //dataType: "json",
            success: function(result){
                current_row =""
                var table_row = ""
                var object_field_val_table = $('#main-tab').find('#report_table');
                for(var i= 0 ;i< result.length;i++)
                {
                    console.log(result[i])
                    if($("#"+result[i][grp_name]).length === 0)
                    {
                        //$("#report_table").append("<tr id="+result[i][grp_name]+"></tr>");
                        $(object_field_val_table).find("#dis_tab").append("<tr id="+result[i][grp_name]+"></tr>")
                    }
                    for(var j=0;j<Object.keys(result[i]).length;j++)
                    {
                        console.log(result[i][grp_name]);
                        $("#"+result[i][grp_name]).append("<td>"+result[i][Object.keys(result[i])[j]]+"</td>")

                    }




//                    for(var j=0;j<result[i].length;j++)
//                    {
//                        if (result[i][j].cname === grp_name)
//                        {
//                            current_row = result[i][j].cvalue;
//                            if($("#"+result[i][j].cvalue).length === 0)
//                            {
//                                $("#report_table").append("<tr id="+result[i][j].cvalue+"><td>"+result[i][j].cvalue+"</td></tr>")
//
//                            }
//
//
//                        }
//                        else
//                         $("#"+current_row).append("<td>"+result[i][j].cvalue+"</td>")



//                        table_row += "<td>"+result[i][j].cvalue+"</td>"
//                    }
//                    $("#report_table").append("<tr>"+table_row+"</tr>")
                    table_row = ""


//                    console.log(result[i])
                }
//                var j=0;
//                $.each(result,function(i,v){
//
//                    var a= $('#dis_tab').append('<tr id='+ (v.cname+j)+'></tr>');
//                    $('#'+v.cname+j).append('<td>'+ v.cvalue+'</td>')
//                    j++;
//                });

                apply_dataTable('#report_table', '#report_table_wrapper','#report_table_length', '#report_table_filter');

            }
        });
    }
</script>