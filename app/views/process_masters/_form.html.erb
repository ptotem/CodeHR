<style>
    #sortable {
        list-style-type: none;
        margin: 0;
        padding: 0;
    }

    #sortable li {
        font-size: 1.2em;
    }

    #sortable li span {
        position: absolute;
        margin-left: -1.3em;
    }

    .custom-control-label{
        float: left;
        text-align: left;
        padding-top: 5px;
        text-align: left;
        width: 160px;
    }

</style>
<%= nested_form_for(@process_master, html: {class: "form-horizontal"}) do |f| %>
  <% if @process_master.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(@process_master.errors.count, "error") %> prohibited this process_master from being saved:</h2>

      <ul>
      <% @process_master.errors.full_messages.each do |msg| %>
        <li><%= msg %></li>
      <% end %>
      </ul>
    </div>
  <% end %>

    <div class="row-fluid">
      <div class="span12">
        <div class="control-group">
          <%= f.label :name, :class => "control-label" %>
          <div class="controls">
            <%= f.text_field :name %>
          </div>
        </div>
      </div>
    </div>

    <div class="row-fluid" id="start_nesting_step_master">
      <div class="span12">


            <div class="tabbable tabs-left">
              <ul class="nav nav-tabs" id="sortable">
                <li class="active"><a data-toggle="tab" href="#step1">Step 1</a></li>
              </ul>
              <div class="tab-content">
                <div id="step1" class="tab-pane in active">
                  <%= f.fields_for :step_masters do |step_master| %>
                      <div class="row-fluid">
                        <div class="span6">
                          <div class="control-group">
                            <!--<label class="control-label" style="position: relative; text-align: left; top: -285px;">Step 1</label>-->
                            <label class="control-label">Step 1</label>
                            <div class="controls">
                              <%= step_master.text_field :name, :class=>"step_masters_name_text_fields" %>
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="row-fluid">
                        <div class="span6">
                          <div class="control-group">
                            <label class="custom-control-label">Class Name</label>
                            <div class="controls">
                              <%= select_tag 'oclass', options_for_select(Mongoid.models.collect{ |u| [u] }) %>
                            </div>
                          </div>
                        </div>
                        <div class="span6">
                          <div class="control-group">
                            <label class="custom-control-label">Action Name</label>
                            <div class="controls">
                              <%= step_master.text_field :oaction %>
                            </div>
                          </div>
                        </div>
                      </div>

                      <div class="row-fluid">
                        <div class="offset2 span8" style="border: 1px solid #C5D0DC; width: 70.5%; margin-left: 15.094%;">
                          <h4 style="padding-left: 2%;">Different Options</h4>

                          <div class="row-fluid">
                            <div class="span6">
                              <div class="control-group">
                                <label class="custom-control-label" style="padding:0 0 0 4%;">
                                  <%= radio_button_tag 'action_option', "single", true, :class => "action_input" %><span class="lbl">Single</span>
                                </label>
                              </div>

                            </div>
                            <div class="span6">
                              <div class="control-group">
                                <label class="custom-control-label" style="padding:0 0 0 4%;">
                                  <%= radio_button_tag 'action_option', "bulk", true, :class => "action_input" %><span class="lbl">Bulk</span>
                                </label>
                              </div>
                            </div>
                          </div>

                        </div>
                      </div>

                      <%= step_master.link_to_remove "Remove this record" %>

                  <% end %>
                </div>
              </div>
            </div>
        <%= f.link_to_add "Add new record", :step_masters %>

        <div class="row-fluid">
          <div class="offset2 span6">
            <h5 id="users_list_header" class="header">Users List</h5>
            <h5 id="not_available_text">No Users available</h5>
            <table id="users_list" class="table table-striped table-bordered table-hover" style="display: none;">
              <tr>
                <th>Check</th>
                <th>Radio</th>
                <th>User Name</th>
                <th>E-mail</th>
              </tr>
              <tr>
              </tr>
            </table>
          </div>
        </div>


      </div>
    </div>
    <br>
  <div class="actions">
    <%= f.submit @form_config[:submit], :class=>"btn btn-info" %>
  </div>

<% end %>

<script type="text/javascript" src="//code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
<script type="text/javascript" src="/assets/jquery.mjs.nestedSortable.js"></script>

<script>
    var nested_form_name_text_fields_len;

    $(function() {

        $("#sortable").sortable();  //nested form's fields (step_master -> steps) sortable

        $('.control-label').css('text-align','left');
        //$(':checkbox, :radio').css('opacity','1');

//        $(".action_input").on('change', function(){
//            if( $(this).is(":checked") ){
//                var val = $(this).val();
//                //alert(val);
//            }
//        }); //checking value of single/bulk radio button

        $("#action_option_bulk").on('change', function(){
            if( $(this).is(":checked") ){
                $("input.user_select_radio").attr("disabled", true);
                $("input.user_select_radio").hide();
                $("input.user_select_checkbox").removeAttr("disabled");
                $("input.user_select_checkbox").show();
            }
        });

        $("#action_option_single").on('change', function(){
            if( $(this).is(":checked") ){
                $("input.user_select_checkbox").attr("disabled", true);
                $("input.user_select_checkbox").hide();
                $("input.user_select_radio").removeAttr("disabled");
                $("input.user_select_radio").show();
            }
        });

        //newly added newsted fields in tabbable
        $('a.add_nested_fields').on('click', function(){
            nested_form_name_text_fields_len = $("#start_nesting_step_master").find(".step_masters_name_text_fields").length + 1; //get number of name text fields in nested form (step_master)

            $('#sortable').find('li').removeClass('active');
            var ht = '<li class="active">' +
                        '<a data-toggle="tab" href=#step'+nested_form_name_text_fields_len+'>' + "Step "+nested_form_name_text_fields_len + '</a>' +
                     '</li>'; //html for tab list (Step 1, Step 2, etc...).

            $("#sortable").append(ht); //add tab in list of steps

            $(this).prev().find('.tab-content').find("#step"+nested_form_name_text_fields_len).find('.control-label').text("");
            $(this).prev().find('.tab-content').find("#step"+nested_form_name_text_fields_len).find('.control-label').text("Step " + nested_form_name_text_fields_len);  //change label of step_master's name field acc. to sequence

            //using nested_form's prototype which gets the html of of newly added nested field
            window.NestedFormEvents.prototype.insertFields = function(content, assoc, link) {
                l =  $(content).find(".control-label").text("Step " + nested_form_name_text_fields_len);
                $(content).append(l)
                var content_html = $(content).html();

                var $tr = $(link).prev().find('.tab-content').find(".tab-pane:last-child"); //get last added tab
                $('.tab-content').find('.tab-pane').removeClass('in active');
                var c =  $(content).insertAfter($tr).wrap('<div id=step'+nested_form_name_text_fields_len+' class="tab-pane in active">'); //insert new nested form in tab after last tab
                c.find(".control-label").remove();
                return c.append(l);
                //return $tr.append(content);
            }

//            $('.tab-content').find('.tab-pane').not(':first').find('.control-group').find('.control-label').css({
//                'text-align':'left',
//                'position': 'relative',
//                'top': '-285px'
//            });


        });

        $('#oclass').on('change', function() {
            var model_name = $(this).val();

            var data = {model_name: []};
            data["model_name"].push(model_name);

            $.ajax({
                url: "/get_data",
                type: "post",
                async: false,
                data: JSON.stringify(data),
                contentType: "application/json",
                success: function (data) {
                    //alert(data);
                    $('#users_list').show();
                    $('#not_available_text').hide();
                    var user_name, email;
                    var user_name_td, email_td;
                    var $user_row;
                    var $checkbox_col = '<td style="position: relative;"><input type="checkbox" name="vehicle" value="Car" class="user_select_checkbox" style="position: relative; top: 0;"></td>';
                    var $radio_button_col = '<td style="position: relative;"><input type="radio" name="sex" value="female" class="user_select_radio" style="position: relative; top: 0;"></td>';
                    //$("#users_list").empty();
                    $("#users_list tr:not(:first-child)").empty();
                    $.each(data.split(','), function (d, ele) {
                        ele = ele.toString().replace('[', '').replace(']', '').replace(/"/g, '');
                        user_name = ele.split('|')[0];
                        email = ele.split('|')[1];
                        $user_row = '<tr>'+$checkbox_col+$radio_button_col+'<td>'+user_name+'</td><td>'+email+'</td></tr>';
                        $("#users_list").append($user_row);
                    });
                    $(':checkbox, :radio').css('opacity','1');
                }
            });

        });

        //view settings for edit form
        var form_id = $('.form-horizontal').attr('id');
        var form_act = form_id.split("_")[0];

        //execute this code in edit mode
        if (form_act == "edit"){
            var $edit_fields, edit_fields_len;
            $edit_fields = $(".tab-content").find('.tab-pane').find(".fields");
            $('.tab-pane').empty().remove();
            $('.nav-tabs#sortable').empty();

            $edit_fields.each(function(index,elem){
                tab_list = '<li>' +
                        '<a data-toggle="tab" href=#step'+(index+1)+'>' + "Step "+(index+1)+ '</a>' +
                        '</li>';
                $('.nav-tabs#sortable').append(tab_list);
                var a="step"+(index+1);
                $('.tab-content').append('<div id='+a+' class="tab-pane in active">'+$(elem).html()+'</div>');
            });

            $('.tab-pane:not(:first)').hide();

            $("#sortable").find('li').on('click', function() {
                var this_li_child_href = $(this).children().attr('href');
                var lastChar = this_li_child_href.substr(this_li_child_href.length - 1); // => "1"
                var intlastChar;
                intlastChar = parseInt(lastChar);
                $('.tab-pane').hide();
                $("#step"+intlastChar).show();
            });
        }

    });


</script>
